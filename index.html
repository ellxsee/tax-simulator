<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tax Simulator ‚Ä¢ 2025 Multi-Page (Calc Enabled + Credits)</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; --ok:#34d399; --warn:#fbbf24; }
    html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui}
    header{background:#111827;padding:12px 20px;display:flex;align-items:center;gap:16px;position:sticky;top:0;z-index:10;border-bottom:1px solid #1f2937}
    header h1{margin:0;font-size:20px}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    nav button{border:0;border-radius:8px;padding:8px 12px;cursor:pointer;background:var(--panel);color:var(--ink)}
    nav button.active{background:var(--accent);color:#001018;font-weight:700}
    .wrap{max-width:1000px;margin:auto;padding:18px}
    section.page{display:none;padding:10px}
    section.page.active{display:block}
    .panel{background:var(--panel);padding:16px;border-radius:12px;margin-bottom:16px;border:1px solid #1f2937}
    .grid{display:grid;gap:12px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    label{display:block;margin:8px 0 4px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:var(--ink)}
    .btn{background:var(--accent);border:0;border-radius:8px;padding:10px 14px;color:#001018;font-weight:700;cursor:pointer}
    .btn.ghost{background:#223042;color:var(--ink)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .note{color:var(--muted);font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1f2937;padding:8px;text-align:right}
    th:first-child,td:first-child{text-align:left}
    .money{font-variant-numeric:tabular-nums}
    .pill{display:inline-block;background:#223042;border:1px solid #334155;border-radius:999px;padding:6px 10px}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Tax Simulator 2025</h1>
    <nav id="navTabs" class="row"></nav>
    <div class="row" style="margin-left:auto">
      <button class="btn ghost" id="saveBtn">üíæ Save</button>
      <button class="btn ghost" id="clearBtn">üóëÔ∏è Clear</button>
      <button class="btn" id="printBtn">üñ®Ô∏è Print/PDF</button>
    </div>
  </header>

  <main class="wrap">

    <!-- Filing & Household -->
    <section class="page active" id="page-filing" data-title="Filing">
      <h2>Filing & Household (2025)</h2>
      <div class="panel grid cols-2">
        <div>
          <label>Filing Status</label>
          <select name="filing.status">
            <option value="single">Single</option>
            <option value="mfj">Married Filing Jointly</option>
            <option value="mfs">Married Filing Separately</option>
            <option value="hoh">Head of Household</option>
            <option value="qwid">Qualifying Widow(er)</option>
          </select>
          <label>Dependents (count)</label><input name="filing.deps" type="number" min="0" step="1" />
        </div>
        <div>
          <label>Standard Deduction (2025, editable)</label><input name="filing.stdDed" type="number" step="0.01" placeholder="Enter per status" />
          <label>Additional SD (age 65+/blind) total</label><input name="filing.addSD" type="number" step="0.01" value="0" />
          <div class="note">Enter the 2025 standard deduction for the chosen status (training/demo). Values can be updated as IRS figures finalize.</div>
        </div>
      </div>

      <div class="panel">
        <h3>Tax Filers</h3>
        <div class="grid cols-2">
          <div>
            <label>Primary ‚Äî Full Name</label><input name="filer.p1.name" placeholder="Jane Q. Taxpayer" />
            <label>Primary ‚Äî SSN (demo)</label><input name="filer.p1.ssn" placeholder="123-45-6789" />
            <label>Primary ‚Äî DOB</label><input name="filer.p1.dob" type="date" />
          </div>
          <div>
            <label>Spouse ‚Äî Full Name (if MFJ)</label><input name="filer.p2.name" placeholder="John A. Taxpayer" />
            <label>Spouse ‚Äî SSN (demo)</label><input name="filer.p2.ssn" placeholder="123-45-6789" />
            <label>Spouse ‚Äî DOB</label><input name="filer.p2.dob" type="date" />
            <div class="note">Leave spouse fields blank unless filing status is MFJ.</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <h3>Dependents</h3>
        <div id="depsList"></div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="addDepBtn">Ôºã Add Dependent</button>
          <div class="note">Each dependent: name, SSN (demo), DOB, relationship, student flag (helps AOTC/EIC).</div>
        </div>
      </div>

      <div class="row"><button class="btn next">Next ‚ûú</button></div>
    </section>

    <!-- W2 -->
    <section class="page" id="page-w2" data-title="W-2">
      <h2>W-2 (Wage and Tax Statement)</h2>
      <div class="panel grid cols-2">
        <div>
          <label>Box 1 ‚Äî Wages, tips, other comp</label><input name="w2.box1" type="number" step="0.01" />
          <label>Box 2 ‚Äî Federal income tax withheld</label><input name="w2.box2" type="number" step="0.01" />
          <label>Box 3 ‚Äî Social security wages</label><input name="w2.box3" type="number" step="0.01" />
          <label>Box 4 ‚Äî Social security tax withheld</label><input name="w2.box4" type="number" step="0.01" />
          <label>Box 5 ‚Äî Medicare wages and tips</label><input name="w2.box5" type="number" step="0.01" />
          <label>Box 6 ‚Äî Medicare tax withheld</label><input name="w2.box6" type="number" step="0.01" />
          <label>Box 7 ‚Äî Social security tips</label><input name="w2.box7" type="number" step="0.01" />
          <label>Box 8 ‚Äî Allocated tips</label><input name="w2.box8" type="number" step="0.01" />
        </div>
        <div>
          <label>Box 10 ‚Äî Dependent care benefits</label><input name="w2.box10" type="number" step="0.01" />
          <label>Box 11 ‚Äî Nonqualified plans</label><input name="w2.box11" type="number" step="0.01" />
          <label>Box 12 ‚Äî Codes/amounts</label><textarea name="w2.box12" rows="5" placeholder="e.g., 12a: D 5000; 12b: DD 2400"></textarea>
          <label>Box 13 ‚Äî Statutory/Retirement/Third-party</label><input name="w2.box13" placeholder="check any that apply" />
          <label>Box 14 ‚Äî Other</label><textarea name="w2.box14" rows="3"></textarea>
          <label>Box 15-20 ‚Äî State/Local info</label><textarea name="w2.box15_20" rows="5" placeholder="State wages & tax (enter totals in State page withholding)"></textarea>
        </div>
      </div>
      <div class="row"><button class="btn ghost prev">‚¨Ö Back</button><button class="btn next">Next ‚ûú</button></div>
    </section>

    <!-- 1099 NEC -->
    <section class="page" id="page-1099nec" data-title="1099-NEC">
      <h2>Form 1099-NEC</h2>
      <div class="panel grid cols-2">
        <div>
          <label>Box 1 ‚Äî Nonemployee compensation</label><input name="nec.box1" type="number" step="0.01" />
          <label>Box 4 ‚Äî Federal income tax withheld</label><input name="nec.box4" type="number" step="0.01" />
          <label>Box 5 ‚Äî State tax withheld</label><input name="nec.box5" type="number" step="0.01" />
        </div>
        <div>
          <label>Box 6 ‚Äî State/Payer‚Äôs state no.</label><input name="nec.box6" />
          <label>Box 7 ‚Äî State income</label><input name="nec.box7" type="number" step="0.01" />
          <label>Payer/Recipient details</label><textarea name="nec.meta" rows="4" placeholder="Payer TIN, Recipient TIN, address, etc."></textarea>
        </div>
      </div>
      <div class="row"><button class="btn ghost prev">‚¨Ö Back</button><button class="btn next">Next ‚ûú</button></div>
    </section>

    <!-- 1099 G -->
    <section class="page" id="page-1099g" data-title="1099-G">
      <h2>Form 1099-G</h2>
      <div class="panel grid cols-2">
        <div>
          <label>Box 1 ‚Äî Unemployment compensation</label><input name="g.box1" type="number" step="0.01" />
          <label>Box 2 ‚Äî State/local income tax refunds</label><input name="g.box2" type="number" step="0.01" />
          <label>Box 3 ‚Äî Box 2 tax year</label><input name="g.box3" placeholder="YYYY" />
          <label>Box 4 ‚Äî Federal income tax withheld</label><input name="g.box4" type="number" step="0.01" />
        </div>
        <div>
          <label>Box 5 ‚Äî RTAA payments</label><input name="g.box5" type="number" step="0.01" />
          <label>Box 6 ‚Äî Taxable grants</label><input name="g.box6" type="number" step="0.01" />
          <label>Box 11 ‚Äî State income tax withheld</label><input name="g.box11" type="number" step="0.01" />
          <label>Payer/Recipient details</label><textarea name="g.meta" rows="4"></textarea>
        </div>
      </div>
      <div class="row"><button class="btn ghost prev">‚¨Ö Back</button><button class="btn next">Next ‚ûú</button></div>
    </section>

    <!-- 1099 INT -->
    <section class="page" id="page-1099int" data-title="1099-INT">
      <h2>Form 1099-INT (Interest)</h2>
      <div class="panel grid cols-2">
        <div>
          <label>Box 1 ‚Äî Interest income</label><input name="int.box1" type="number" step="0.01" />
          <label>Box 2 ‚Äî Early withdrawal penalty</label><input name="int.box2" type="number" step="0.01" />
          <label>Box 3 ‚Äî U.S. bond/Treasury interest</label><input name="int.box3" type="number" step="0.01" />
          <label>Box 4 ‚Äî Federal income tax withheld</label><input name="int.box4" type="number" step="0.01" />
          <label>Box 5 ‚Äî Investment expenses</label><input name="int.box5" type="number" step="0.01" />
        </div>
        <div>
          <label>Box 6 ‚Äî Foreign tax paid</label><input name="int.box6" type="number" step="0.01" />
          <label>Box 8 ‚Äî Tax-exempt interest</label><input name="int.box8" type="number" step="0.01" />
          <label>Box 9 ‚Äî PAB tax-exempt interest</label><input name="int.box9" type="number" step="0.01" />
          <label>Box 10 ‚Äî Market discount</label><input name="int.box10" type="number" step="0.01" />
          <label>Box 11 ‚Äî Bond premium</label><input name="int.box11" type="number" step="0.01" />
        </div>
      </div>
      <div class="row"><button class="btn ghost prev">‚¨Ö Back</button><button class="btn next">Next ‚ûú</button></div>
    </section>

    <!-- 1099 DIV -->
    <section class="page" id="page-1099div" data-title="1099-DIV">
      <h2>Form 1099-DIV (Dividends)</h2>
      <div class="panel grid cols-2">
        <div>
          <label>Box 1a ‚Äî Total ordinary dividends</label><input name="div.box1a" type="number" step="0.01" />
          <label>Box 1b ‚Äî Qualified dividends</label><input name="div.box1b" type="number" step="0.01" />
          <label>Box 2a ‚Äî Total capital gain distributions</label><input name="div.box2a" type="number" step="0.01" />
          <label>Box 2b ‚Äî Unrecap. Sec. 1250 gain</label><input name="div.box2b" type="number" step="0.01" />
          <label>Box 2c ‚Äî Sec. 1202 gain</label><input name="div.box2c" type="number" step="0.01" />
        </div>
        <div>
          <label>Box 2d ‚Äî Collectibles (28%) gain</label><input name="div.box2d" type="number" step="0.01" />
          <label>Box 3 ‚Äî Nondividend distributions</label><input name="div.box3" type="number" step="0.01" />
          <label>Box 4 ‚Äî Federal income tax withheld</label><input name="div.box4" type="number" step="0.01" />
          <label>Box 6 ‚Äî Foreign tax paid</label><input name="div.box6" type="number" step="0.01" />
          <label>Box 11 ‚Äî Exempt-interest dividends</label><input name="div.box11" type="number" step="0.01" />
        </div>
      </div>
      <div class="row"><button class="btn ghost prev">‚¨Ö Back</button><button class="btn next">Next ‚ûú</button></div>
    </section>

    <!-- 1099 R -->
    <section class="page" id="page-1099r" data-title="1099-R">
      <h2>Form 1099-R (Retirement Distributions)</h2>
      <div class="panel grid cols-2">
        <div>
          <label>Box 1 ‚Äî Gross distribution</label><input name="r.box1" type="number" step="0.01" />
          <label>Box 2a ‚Äî Taxable amount</label><input name="r.box2a" type="number" step="0.01" />
          <label>Box 2b ‚Äî Taxable amount not determined / total distribution</label><input name="r.box2b" placeholder="check boxes if applicable" />
          <label>Box 4 ‚Äî Federal income tax withheld</label><input name="r.box4" type="number" step="0.01" />
          <label>Box 7 ‚Äî Distribution code(s)</label><input name="r.box7" />
        </div>
        <div>
          <label>Box 9a ‚Äî Total distribution %</label><input name="r.box9a" type="number" step="0.01" />
          <label>Box 12 ‚Äî State tax withheld</label><input name="r.box12" type="number" step="0.01" />
          <label>Box 13 ‚Äî State/Payer‚Äôs state no.</label><input name="r.box13" />
          <label>Box 14 ‚Äî State distribution</label><input name="r.box14" type="number" step="0.01" />
          <label>Payer/Recipient details</label><textarea name="r.meta" rows="4"></textarea>
        </div>
      </div>
      <div class="row"><button class="btn ghost prev">‚¨Ö Back</button><button class="btn next">Next ‚ûú</button></div>
    </section>

    <!-- SSA 1099 -->
    <section class="page" id="page-ssa1099" data-title="SSA-1099">
      <h2>Form SSA-1099 (Social Security)</h2>
      <div class="panel grid cols-2">
        <div>
          <label>Box 3 ‚Äî Benefits paid in 20XX</label><input name="ssa.box3" type="number" step="0.01" />
          <label>Box 4 ‚Äî Benefits repaid in 20XX</label><input name="ssa.box4" type="number" step="0.01" />
          <label>Box 5 ‚Äî Net benefits for 20XX</label><input name="ssa.box5" type="number" step="0.01" />
        </div>
        <div>
          <label>Box 6 ‚Äî Voluntary fed tax withheld</label><input name="ssa.box6" type="number" step="0.01" />
          <label>Medicare premiums (info)</label><input name="ssa.medicare" type="number" step="0.01" />
          <label>Notes</label><textarea name="ssa.meta" rows="4"></textarea>
        </div>
      </div>
      <div class="row"><button class="btn ghost prev">‚¨Ö Back</button><button class="btn next">Next ‚ûú</button></div>
    </section>

    <!-- 1095 A -->
    <section class="page" id="page-1095a" data-title="1095-A">
      <h2>Form 1095-A (Marketplace Health)</h2>
      <div class="panel">
        <div class="note">Enter totals (A/B/C). Premium Tax Credit reconciliation is not automated in this demo.</div>
        <div class="grid cols-3">
          <div>
            <label>Column A ‚Äî Monthly premiums (total)</label><input name="1095a.colA" type="number" step="0.01" />
            <label>Column C ‚Äî Advance PTC received (total)</label><input name="1095a.colC" type="number" step="0.01" />
          </div>
          <div>
            <label>Column B ‚Äî SLCSP (total)</label><input name="1095a.colB" type="number" step="0.01" />
            <label>Household size</label><input name="1095a.hh" type="number" />
          </div>
          <div>
            <label>FPL % (if known)</label><input name="1095a.fpl" type="number" step="0.01" />
            <label>Notes</label><textarea name="1095a.meta" rows="3"></textarea>
          </div>
        </div>
      </div>
      <div class="row"><button class="btn ghost prev">‚¨Ö Back</button><button class="btn next">Next ‚ûú</button></div>
    </section>

    <!-- 1098-T (NEW) -->
    <section class="page" id="page-1098t" data-title="1098-T">
      <h2>Form 1098-T (Tuition)</h2>
      <div class="panel grid cols-2">
        <div>
          <label>Box 1 ‚Äî Payments for qualified tuition/expenses</label><input name="t.box1" type="number" step="0.01" />
          <label>Scholarships/grants (reduce qualified expenses)</label><input name="t.sch" type="number" step="0.01" />
          <label>Books & required materials (out-of-pocket)</label><input name="t.books" type="number" step="0.01" />
          <label>Academic period qualifies for AOTC?</label>
          <select name="t.aotcElig">
            <option value="yes">Yes (first 4 years, at least half-time)</option>
            <option value="no">No / Graduate / Not half-time</option>
          </select>
        </div>
        <div>
          <label>Choose credit (or Auto)</label>
          <select name="t.creditSel">
            <option value="auto">Auto (AOTC if eligible, else LLC)</option>
            <option value="aotc">Force AOTC</option>
            <option value="llc">Force Lifetime Learning</option>
          </select>
          <label>MAGI override for education phaseout (optional)</label><input name="t.magi" type="number" step="0.01" />
          <div class="pill" style="margin-top:8px">AOTC (nonref+ref): <strong id="tAOTCOut">$0</strong> ‚Ä¢ LLC: <strong id="tLLCOut">$0</strong></div>
          <div class="note">Demo rules: AOTC = 100% of first $2k + 25% of next $2k (max $2,500). Up to $1,000 refundable; same MAGI phaseouts as IRS (simplified). LLC = 20% of up to $10k (max $2,000), non-refundable.</div>
        </div>
      </div>
      <div class="row"><button class="btn ghost prev">‚¨Ö Back</button><button class="btn next">Next ‚ûú</button></div>
    </section>

    <!-- Schedule C -->
    <section class="page" id="page-schc" data-title="Schedule C">
      <h2>Schedule C ‚Äî Business</h2>
      <div class="panel grid cols-2">
        <div>
          <label>Gross income</label><input name="schc.gross" type="number" step="0.01" />
          <label>Returns & allowances</label><input name="schc.returns" type="number" step="0.01" />
          <label>Other income</label><input name="schc.other" type="number" step="0.01" />
        </div>
        <div>
          <label>Total expenses</label><input name="schc.exp" type="number" step="0.01" />
          <label>Home office (incl. in exp)</label><input name="schc.home" type="number" step="0.01" />
          <label>Vehicle (incl. in exp)</label><input name="schc.veh" type="number" step="0.01" />
        </div>
      </div>
      <div class="row"><button class="btn ghost prev">‚¨Ö Back</button><button class="btn next">Next ‚ûú</button></div>
    </section>

    <!-- Schedule E -->
    <section class="page" id="page-sche" data-title="Schedule E">
      <h2>Schedule E ‚Äî Rentals/Royalties</h2>
      <div class="panel grid cols-2">
        <div>
          <label>Income</label><input name="sche.inc" type="number" step="0.01" />
        </div>
        <div>
          <label>Expenses</label><input name="sche.exp" type="number" step="0.01" />
        </div>
      </div>
      <div class="row"><button class="btn ghost prev">‚¨Ö Back</button><button class="btn next">Next ‚ûú</button></div>
    </section>

    <!-- Schedule A -->
    <section class="page" id="page-scha" data-title="Schedule A">
      <h2>Schedule A ‚Äî Itemized</h2>
      <div class="panel grid cols-2">
        <div>
          <label>Medical (over floor)</label><input name="scha.med" type="number" step="0.01" />
          <label>SALT taxes (cap)</label><input name="scha.salt" type="number" step="0.01" />
          <label>Mortgage interest</label><input name="scha.int" type="number" step="0.01" />
        </div>
        <div>
          <label>Charitable gifts</label><input name="scha.char" type="number" step="0.01" />
          <label>Other itemized</label><input name="scha.other" type="number" step="0.01" />
          <label>Standard deduction (override)</label><input name="std.ded" type="number" step="0.01" />
        </div>
      </div>
      <div class="row"><button class="btn ghost prev">‚¨Ö Back</button><button class="btn next">Next ‚ûú</button></div>
    </section>

    <!-- EV Credit -->
    <section class="page" id="page-ev" data-title="EV Credit (8936)">
      <h2>Electric Vehicle Credit ‚Äî Form 8936 (Demo)</h2>
      <div class="panel grid cols-2">
        <div>
          <label>Vehicle type</label>
          <select name="ev.type"><option value="new">New</option><option value="used">Used</option></select>
          <label>Purchase date</label><input name="ev.date" type="date" />
          <label>Purchase price</label><input name="ev.price" type="number" step="0.01" />
          <label>VIN (demo)</label><input name="ev.vin" />
        </div>
        <div>
          <label>Battery capacity (kWh)</label><input name="ev.kwh" type="number" step="0.1" />
          <label>Final assembly in North America?</label>
          <select name="ev.na"><option value="yes">Yes</option><option value="no">No</option></select>
          <label>MAGI (for demo phaseout)</label><input name="ev.magi" type="number" step="0.01" />
          <div class="pill" style="margin-top:8px">Estimated EV Credit: <strong id="evCreditOut">$0</strong> (non-refundable)</div>
          <div class="note">Demo rules: $7,500 max for new (or 15% of price), $4,000 max for used (or 30% of price). Assembly and simple income screen applied.</div>
        </div>
      </div>
      <div class="row"><button class="btn ghost prev">‚¨Ö Back</button><button class="btn next">Next ‚ûú</button></div>
    </section>

    <!-- Solar/Energy -->
    <section class="page" id="page-energy" data-title="Solar & Energy (5695)">
      <h2>Residential Clean Energy ‚Äî Form 5695 (Demo)</h2>
      <div class="panel grid cols-2">
        <div>
          <label>Solar PV cost</label><input name="en.solar" type="number" step="0.01" />
          <label>Battery storage cost</label><input name="en.battery" type="number" step="0.01" />
          <label>Other eligible energy improvements</label><input name="en.other" type="number" step="0.01" />
          <label>Year placed in service</label><input name="en.year" type="number" step="1" />
        </div>
        <div>
          <label>Tax liability before energy credits (estimate)</label><input name="en.taxliab" type="number" step="0.01" />
          <div class="pill" style="margin-top:8px">Energy Credit (30%): <strong id="enCreditOut">$0</strong></div>
          <div class="pill" style="margin-top:8px">Applied this year: <strong id="enAppliedOut">$0</strong> ‚Ä¢ Carryforward (demo): <strong id="enCarryOut">$0</strong></div>
          <div class="note">Demo rules: 30% of eligible costs; non-refundable; any excess shown as carryforward.</div>
        </div>
      </div>
      <div class="row"><button class="btn ghost prev">‚¨Ö Back</button><button class="btn next">Next ‚ûú</button></div>
    </section>

    <!-- State -->
    <section class="page" id="page-state" data-title="State">
      <h2>State Tax Module</h2>
      <div class="panel grid cols-2">
        <div>
          <label>State</label><select name="state.code"><option>AZ</option><option>CA</option><option>FL</option><option>NY</option><option>TX</option><option>WA</option></select>
          <label>Mode</label><select name="state.mode"><option value="brackets">Tiered</option><option value="flat">Flat</option></select>
          <label>Flat rate</label><input name="state.flat" type="number" step="0.0001" value="0.05" />
        </div>
        <div>
          <label>Adjustments (+/- per line)</label><textarea name="state.adj" rows="5"></textarea>
          <label>Credits</label><input name="state.credits" type="number" step="0.01" />
          <label>Withholding (total state)</label><input name="state.wh" type="number" step="0.01" />
        </div>
      </div>
      <details class="panel"><summary>Demo State Tables (editable JSON)</summary>
        <pre id="stateJson" style="white-space:pre-wrap"></pre>
      </details>
      <div class="row"><button class="btn ghost prev">‚¨Ö Back</button><button class="btn next" id="toResults">Calculate ‚ûú</button></div>
    </section>

    <!-- Payment -->
    <section class="page" id="page-pay" data-title="Payment">
      <h2>Payments & Receipt</h2>
      <div class="panel grid cols-2">
        <div>
          <label>Service tier</label><select name="pay.tier"><option>Basic</option><option>Deluxe</option><option>Premium</option></select>
          <label>Method</label><select name="pay.method"><option>Card</option><option>ACH</option><option>Cash (demo)</option></select>
          <button class="btn" id="markPaid">Mark as Paid</button>
          <div id="paidBadge" class="pill" style="display:none">‚úÖ Paid</div>
        </div>
        <div>
          <label>Receipt notes</label><textarea name="pay.notes" rows="6"></textarea>
          <button class="btn ghost" id="genReceipt">Generate Receipt</button>
        </div>
      </div>
      <div class="panel" id="receiptPanel" style="display:none">
        <h3>üßæ Receipt</h3>
        <div id="receiptBody"></div>
      </div>
      <div class="row"><button class="btn ghost prev">‚¨Ö Back</button></div>
    </section>

    <!-- Results -->
    <section class="page" id="page-results" data-title="Results">
      <h2>Estimated Return (2025)</h2>
      <div class="panel grid cols-2">
        <div>
          <table>
            <tbody>
              <tr><td>W-2 wages</td><td class="money" id="outW2">$0.00</td></tr>
              <tr><td>NEC/Business net (to Sch C)</td><td class="money" id="outNEC">$0.00</td></tr>
              <tr><td>1099-G taxable</td><td class="money" id="outG">$0.00</td></tr>
              <tr><td>Interest (1099-INT, taxable)</td><td class="money" id="outINT">$0.00</td></tr>
              <tr><td>Dividends (ordinary)</td><td class="money" id="outDIV">$0.00</td></tr>
              <tr><td>1099-R taxable</td><td class="money" id="outR">$0.00</td></tr>
              <tr><td>Schedule E net</td><td class="money" id="outE">$0.00</td></tr>
              <tr><th>Total Income</th><th class="money" id="outTotInc">$0.00</th></tr>
              <tr><td>Itemized deduction</td><td class="money" id="outItemized">$0.00</td></tr>
              <tr><td>Standard deduction</td><td class="money" id="outStd">$0.00</td></tr>
              <tr><th>Taxable Income</th><th class="money" id="outTaxable">$0.00</th></tr>
            </tbody>
          </table>
        </div>
        <div>
          <table>
            <tbody>
              <tr><td>Federal income tax (brackets)</td><td class="money" id="outFedTax">$0.00</td></tr>
              <tr><td>Self-employment tax</td><td class="money" id="outSETax">$0.00</td></tr>
              <tr><td><strong>Nonrefundable credits applied</strong></td><td class="money" id="outNonRefCred">$0.00</td></tr>
              <tr><td>State tax (after state credits)</td><td class="money" id="outStateTax">$0.00</td></tr>
              <tr><td>Withholdings (fed+state)</td><td class="money" id="outWH">$0.00</td></tr>
              <tr><td><strong>Refundable credits</strong></td><td class="money" id="outRefCred">$0.00</td></tr>
              <tr><th>Refund / Amount Due</th><th class="money" id="outRefund">$0.00</th></tr>
            </tbody>
          </table>
          <div class="note">
            Demo credits included: <strong>CTC, EIC, AOTC/LLC, EV (8936), Energy (5695)</strong>.
            Non-refundable credits offset income tax (not SE tax). Values are simplified for training.
          </div>
        </div>
      </div>
      <div class="row"><button class="btn ghost prev">‚¨Ö Back</button></div>
    </section>

  </main>

  <script>
    // ================= DEMO CONSTANTS (EASY TO EDIT) =================
    const DEMO_YEAR = 2025;
    // Federal brackets (editable demo)
    const fedBrackets = {
      single:  [[11000,0.10],[44725,0.12],[95375,0.22],[182100,0.24],[231250,0.32],[578125,0.35],[null,0.37]],
      mfj:     [[22000,0.10],[89450,0.12],[190750,0.22],[364200,0.24],[462500,0.32],[693750,0.35],[null,0.37]],
      mfs:     [[11000,0.10],[44725,0.12],[95375,0.22],[182100,0.24],[231250,0.32],[346875,0.35],[null,0.37]],
      hoh:     [[15700,0.10],[59850,0.12],[95350,0.22],[182100,0.24],[231250,0.32],[578100,0.35],[null,0.37]],
      qwid:    [[22000,0.10],[89450,0.12],[190750,0.22],[364200,0.24],[462500,0.32],[693750,0.35],[null,0.37]]
    };
    // State (unchanged from your demo)
    const states = {
      AZ: { name:"Arizona", mode:"brackets", brackets:[[28700,0.0236],[57500,0.0298],[172000,0.0336],[null,0.042]], flat:0.0285 },
      CA: { name:"California", mode:"brackets", brackets:[[10412,0.01],[24684,0.02],[38959,0.04],[54081,0.06],[68350,0.08],[349137,0.093],[418961,0.103],[698271,0.113],[null,0.123]], flat:0 },
      FL: { name:"Florida", mode:"flat", brackets:[], flat:0 },
      NY: { name:"New York", mode:"brackets", brackets:[[8500,0.04],[11700,0.045],[13900,0.0525],[21400,0.059],[80650,0.0621],[215400,0.0649],[1077550,0.0685],[null,0.109]], flat:0 },
      TX: { name:"Texas", mode:"flat", brackets:[], flat:0 },
      WA: { name:"Washington", mode:"flat", brackets:[], flat:0 }
    };

    // ----- CTC (simplified demo) -----
    const CTC = {
      maxPerChild: 2000,             // editable
      refundableCapPerChild: 1600,   // demo A-CTC cap
      phaseoutStart: { single:200000, hoh:200000, mfs:200000, mfj:400000, qwid:400000 },
      refundabilityFloorEarned: 2500,    // 15% * (earned - floor)
      refundabilityRate: 0.15
    };

    // ----- EIC (simplified demo tables ‚Äì close to recent values, editable) -----
    // Using single/hoh baseline; MFJ thresholds add an "MFJ bump"
    const EIC_TABLE = {
      mfjBump: 7000, // increases phaseout thresholds when MFJ (demo)
      // For 0,1,2,3+ qualifying children
      // phaseInRate, maxCredit, phaseOutRate, phaseOutStart(single/hoh)
      rows: [
        { q:0,  inRate:0.0765, max:630,   outRate:0.0765, outStart:8800 },     // childless
        { q:1,  inRate:0.34,   max:3995,  outRate:0.1598, outStart:21560 },
        { q:2,  inRate:0.4,    max:6604,  outRate:0.2106, outStart:21560 },
        { q:3,  inRate:0.45,   max:7430,  outRate:0.2106, outStart:21560 }
      ]
    };

    // ----- Education credits (AOTC/LLC) MAGI phaseouts (demo) -----
    const EDU_PHASEOUT = {
      // thresholds where credit phases out (single/hoh/mfs use single; mfj uses mfj)
      aotc: { single: {start:80000,end:90000}, mfj:{start:160000,end:180000} },
      llc:  { single: {start:80000,end:90000}, mfj:{start:160000,end:180000} }
    };

    // ================= CORE APP =================
    const STORAGE_KEY = 'taxsim2025_calc_v2';
    const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    const byId = id=> document.getElementById(id);
    const money = n=> new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).format(isFinite(n)?n:0);
    const num = v=> { const x = parseFloat(v); return isFinite(x)?x:0; };

    // ---------- Navigation ----------
    const pages = Array.from(document.querySelectorAll('.page'));
    const nav = document.getElementById('navTabs');
    pages.forEach((p,i)=>{
      const btn = document.createElement('button');
      btn.textContent = p.dataset.title || p.querySelector('h2').textContent;
      btn.addEventListener('click',()=>showPage(i)); nav.appendChild(btn);
    });
    function showPage(i){
      pages.forEach((p,j)=>p.classList.toggle('active',i===j));
      Array.from(nav.children).forEach((b,j)=>b.classList.toggle('active',i===j));
      window.scrollTo({top:0,behavior:'smooth'});
      if(pages[i].id==='page-results') compute();
      if(pages[i].id==='page-state') renderStateJson();
    }
    document.body.addEventListener('click',e=>{
      if(e.target.classList.contains('next')){ const idx = activeIndex(); if(idx<pages.length-1) showPage(idx+1); }
      if(e.target.classList.contains('prev')){ const idx = activeIndex(); if(idx>0) showPage(idx-1); }
    });
    function activeIndex(){ return pages.findIndex(p=>p.classList.contains('active')); }

    // ---------- Persistence ----------
    function registerInputs(){
      const inputs = document.querySelectorAll('input[name], select[name], textarea[name]');
      inputs.forEach(el=>{
        const key = el.name;
        if(data[key] !== undefined){ if(el.type==='checkbox') el.checked = !!data[key]; else el.value = data[key]; }
        el.addEventListener('input',()=> saveField(el));
        el.addEventListener('change',()=> saveField(el));
      });
    }
    function saveField(el){ data[el.name] = (el.type==='checkbox')? el.checked : el.value; schedulePersist(); if(el.name.startsWith('t.')||el.name.startsWith('ev.')||el.name.startsWith('en.')) recalcLiveCreditPills(); }
    let persistTimer; function schedulePersist(){ clearTimeout(persistTimer); persistTimer=setTimeout(()=>localStorage.setItem(STORAGE_KEY, JSON.stringify(data)), 150); }

    // ---------- Small utils ----------
    function val(k){ return num(data[k] ?? 0); }
    function taxFromBrackets(income, brackets){ let tax=0, prev=0; for(const [limit,rate] of brackets){ if(limit===null){ tax += Math.max(0,income-prev)*rate; break; } const amt=Math.max(0,Math.min(income,limit)-prev); tax += amt*rate; prev=limit; if(income<=limit) break; } return tax; }
    const ageOn = (dobStr, year)=>{ if(!dobStr) return 0; const d=new Date(dobStr); const ref=new Date(year,11,31); let a=ref.getFullYear()-d.getFullYear(); const md=(ref.getMonth()-d.getMonth()) || (ref.getDate()-d.getDate()); if(md<0) a--; return a; };

    // ---------- Income ----------
    function computeIncomePieces(){
      const w2 = val('w2.box1');
      const nec = val('nec.box1');
      const gUnemp = val('g.box1');
      const gRefund = val('g.box2'); // as entered
      const intTaxable = val('int.box1');
      const divOrd = val('div.box1a');
      const rTaxable = val('r.box2a');
      const eNet = Math.max(0, val('sche.inc') - val('sche.exp'));
      const schcNet = Math.max(0, (nec + val('schc.gross') - val('schc.returns') + val('schc.other')) - val('schc.exp'));
      const totalIncome = w2 + gUnemp + gRefund + intTaxable + divOrd + rTaxable + eNet + schcNet;
      return { w2, nec, gUnemp, gRefund, intTaxable, divOrd, rTaxable, eNet, schcNet, totalIncome };
    }

    // ---------- Deductions ----------
    function computeDeductions(totalIncome){
      const itemized = val('scha.med') + val('scha.salt') + val('scha.int') + val('scha.char') + val('scha.other');
      const stdOverride = val('std.ded');
      const stdEntered = val('filing.stdDed') + val('filing.addSD');
      const standard = stdOverride>0 ? stdOverride : stdEntered;
      const taxable = Math.max(0, totalIncome - Math.max(itemized, standard));
      return { itemized, standard, taxable };
    }

    // ---------- EV & Energy ----------
    function _num(v){ const n=parseFloat(v); return isFinite(n)? n:0; }
    function calcEV(){
      const type=(data['ev.type']||'new');
      const price=_num(data['ev.price']);
      const na=(data['ev.na']||'yes')==='yes';
      const kwh=_num(data['ev.kwh']);
      const fs=(data['filing.status']||'single');
      const magi=_num(data['ev.magi']);
      const isMFJ=(fs==='mfj'); const magiCap=isMFJ?300000: (fs==='hoh'?225000:150000);
      let credit=0;
      if(type==='new') credit=Math.min(7500, price*0.15); else credit=Math.min(4000, price*0.30);
      if(!na) credit=0; if(kwh && kwh<7) credit=0; if(magi && magi>magiCap) credit=0;
      const el=document.getElementById('evCreditOut'); if(el) el.textContent=money(credit);
      data['cred.ev']=credit; return credit;
    }
    function calcEnergy(){
      const total=_num(data['en.solar'])+_num(data['en.battery'])+_num(data['en.other']);
      const credit=total*0.30; const taxliab=_num(data['en.taxliab']);
      const applied=Math.min(credit, taxliab||credit); const carry=Math.max(0, credit - applied);
      const cEl=document.getElementById('enCreditOut'); if(cEl) cEl.textContent=money(credit);
      const aEl=document.getElementById('enAppliedOut'); if(aEl) aEl.textContent=money(applied);
      const xEl=document.getElementById('enCarryOut'); if(xEl) xEl.textContent=money(carry);
      data['cred.energy.total']=credit; data['cred.energy.applied']=applied; data['cred.energy.carry']=carry; return {credit,applied,carry};
    }
    function recalcLiveCreditPills(){ try{calcEV()}catch(e){} try{calcEnergy()}catch(e){} try{previewEdu()}catch(e){} }

    // ---------- Dependents UI (added "Student" checkbox) ----------
    function ensureDeps(){ if(!Array.isArray(data.deps)) data.deps = []; }
    function renderDeps(){
      ensureDeps();
      const wrap = document.getElementById('depsList');
      if(!wrap) return;
      wrap.innerHTML = '';
      if(!data.deps.length){
        const empty = document.createElement('div');
        empty.className='note'; empty.textContent='No dependents added yet.'; wrap.appendChild(empty);
      }
      data.deps.forEach((d,idx)=>{
        const card = document.createElement('div');
        card.className='panel'; card.style.padding='12px'; card.style.margin='8px 0';
        const checked = d.student ? 'checked' : '';
        card.innerHTML = `
          <div class="grid cols-2">
            <div>
              <label>Name</label><input data-field="name" data-idx="${idx}" value="${d.name||''}" placeholder="Full name" />
              <label>SSN (demo)</label><input data-field="ssn" data-idx="${idx}" value="${d.ssn||''}" placeholder="000-00-0000" />
              <label class="row" style="gap:8px;align-items:center;margin-top:8px">
                <input type="checkbox" style="width:auto" data-field="student" data-idx="${idx}" ${checked}/> Student (‚â• half-time)
              </label>
            </div>
            <div>
              <label>DOB</label><input data-field="dob" data-idx="${idx}" type="date" value="${d.dob||''}" />
              <label>Relationship</label><input data-field="rel" data-idx="${idx}" value="${d.rel||''}" placeholder="son/daughter/other" />
              <div class="row" style="margin-top:8px"><button class="btn ghost" data-remove="${idx}">Remove</button></div>
            </div>
          </div>`;
        wrap.appendChild(card);
      });
    }
    function addDep(){ ensureDeps(); data.deps.push({name:'',ssn:'',dob:'',rel:'',student:false}); schedulePersist(); renderDeps(); }
    function removeDep(i){ ensureDeps(); data.deps.splice(i,1); schedulePersist(); renderDeps(); }

    document.addEventListener('input', (e)=>{
      const t = e.target; if(t && t.hasAttribute('data-field')){
        const i = parseInt(t.getAttribute('data-idx')); const f = t.getAttribute('data-field');
        if(!isNaN(i)){ ensureDeps(); const val = (t.type==='checkbox')? t.checked : t.value; data.deps[i] = Object.assign({}, data.deps[i], { [f]: val }); schedulePersist(); }
      }
    });
    document.addEventListener('click', (e)=>{
      const t=e.target; if(t && t.hasAttribute('data-remove')){ const i=parseInt(t.getAttribute('data-remove')); if(!isNaN(i)) removeDep(i); }
    });

    // ---------- Education (1098-T) ----------
    function eduMAGI(){
      // Use override if provided; else use AGI approx = totalIncome for demo
      const { totalIncome } = computeIncomePieces();
      const override = val('t.magi');
      return override>0 ? override : totalIncome;
    }
    function aotcAmount(qQualified, status){
      // AOTC raw formula
      const base = Math.max(0, Math.min(qQualified, 2000));
      const next = Math.max(0, Math.min(Math.max(0,qQualified-2000), 2000))*0.25;
      let raw = base + next; raw = Math.min(2500, raw);
      // Phaseout
      const po = EDU_PHASEOUT.aotc[status==='mfj'?'mfj':'single'];
      const m = eduMAGI();
      if(m<=po.start) return raw;
      if(m>=po.end) return 0;
      const frac = (po.end - m) / (po.end - po.start);
      return raw * Math.max(0, Math.min(1, frac));
    }
    function llcAmount(qQualified, status){
      let raw = Math.min(10000, Math.max(0,qQualified)) * 0.20;
      raw = Math.min(2000, raw);
      const po = EDU_PHASEOUT.llc[status==='mfj'?'mfj':'single'];
      const m = eduMAGI();
      if(m<=po.start) return raw;
      if(m>=po.end) return 0;
      const frac = (po.end - m) / (po.end - po.start);
      return raw * Math.max(0, Math.min(1, frac));
    }
    function previewEdu(){
      const q = Math.max(0, val('t.box1') - val('t.sch')) + Math.max(0, val('t.books'));
      const status = (data['filing.status']||'single');
      const aotcElig = (data['t.aotcElig']||'yes')==='yes';
      const sel = data['t.creditSel']||'auto';
      let aotc = aotcElig? aotcAmount(q, status) : 0;
      let llc = llcAmount(q, status);
      if(sel==='aotc'){ llc=0; }
      if(sel==='llc'){ aotc=0; }
      const aotcOut = byId('tAOTCOut'); if(aotcOut) aotcOut.textContent = money(aotc);
      const llcOut = byId('tLLCOut'); if(llcOut) llcOut.textContent = money(llc);
      data['cred.edu.aotc']=aotc; data['cred.edu.llc']=llc;
      return {aotc,llc,qualified:q};
    }

    // ---------- CTC ----------
    function countQualifyingChildrenCTC(){
      ensureDeps();
      // Qualifying child for CTC (demo): under 17 by 12/31/2025 and relationship child/stepchild/foster (we'll accept rel contains 'son'/'daughter')
      return data.deps.filter(d=>{
        const age = ageOn(d.dob, DEMO_YEAR);
        const rel = (d.rel||'').toLowerCase();
        const isChild = /son|daughter|child|step|foster/.test(rel);
        return age < 17 && isChild;
      }).length;
    }
    function computeCTC(earnedIncome){
      const status = (data['filing.status']||'single');
      const ch = countQualifyingChildrenCTC();
      if(ch<=0) return { total:0, nonref:0, refundable:0 };
      // Phaseout
      const poStart = CTC.phaseoutStart[status] || 200000;
      const { totalIncome } = computeIncomePieces();
      let maxCTC = CTC.maxPerChild * ch;
      if(totalIncome>poStart){
        const excess = totalIncome - poStart;
        const reduction = Math.ceil(excess/1000)*50; // $50 per $1k
        maxCTC = Math.max(0, maxCTC - reduction);
      }
      // Refundability (Additional CTC)
      const potentialRefundable = Math.min(CTC.refundableCapPerChild*ch, Math.max(0, (earnedIncome - CTC.refundabilityFloorEarned) * CTC.refundabilityRate));
      const refundable = Math.min(maxCTC, potentialRefundable);
      const nonref = Math.max(0, maxCTC - refundable);
      return { total:maxCTC, nonref, refundable };
    }

    // ---------- EIC ----------
    function countQualifyingChildrenEIC(){
      ensureDeps();
      return data.deps.filter(d=>{
        const age = ageOn(d.dob, DEMO_YEAR);
        const isStudent = !!d.student;
        const rel = (d.rel||'').toLowerCase();
        const isChild = /son|daughter|child|step|foster/.test(rel);
        // demo: <19 OR <24 & student
        return isChild && (age < 19 || (age < 24 && isStudent));
      }).length;
    }
    function computeEIC(earnedIncome, agi){
      const q = Math.min(3, countQualifyingChildrenEIC());
      const row = EIC_TABLE.rows[q];
      if(!row) return 0;
      const status = (data['filing.status']||'single');
      // Phase-in
      const phaseInCredit = Math.min(row.max, earnedIncome * row.inRate);
      // Phase-out starts at threshold; MFJ bump
      const bump = (status==='mfj') ? EIC_TABLE.mfjBump : 0;
      const outStart = row.outStart + bump;
      let final = phaseInCredit;
      const incomeForPhaseOut = Math.max(earnedIncome, agi);
      if(incomeForPhaseOut > outStart){
        const excess = incomeForPhaseOut - outStart;
        const phaseOut = excess * row.outRate;
        final = Math.max(0, phaseInCredit - phaseOut);
      }
      return final;
    }

    // ---------- Main compute ----------
    function compute(){
      // Incomes
      const inc = computeIncomePieces();
      const ded = computeDeductions(inc.totalIncome);

      // Federal income tax (before credits)
      const status = (data['filing.status']||'single');
      const fedTax = taxFromBrackets(ded.taxable, fedBrackets[status] || fedBrackets.single);

      // Self-employment tax (approx)
      const seIncome = Math.max(0, inc.schcNet * 0.9235);
      const ssBase = 175000; // editable demo
      const ssTax = Math.min(seIncome, ssBase) * 0.124;
      const medTax = seIncome * 0.029;
      const seTax = ssTax + medTax;

      // State tax
      const stCode = (data['state.code']||'AZ');
      const stMode = (data['state.mode']||states[stCode]?.mode||'brackets');
      const stAdj = parseAdj(data['state.adj']||'');
      const stateTaxable = Math.max(0, ded.taxable + stAdj);
      let stateTax = 0;
      if(stMode==='flat'){ const rate = num(data['state.flat']||states[stCode]?.flat||0); stateTax = stateTaxable * rate; }
      else { const br = states[stCode]?.brackets || []; stateTax = taxFromBrackets(stateTaxable, br); }
      stateTax = Math.max(0, stateTax - val('state.credits'));

      // Withholdings
      const fedWH = val('w2.box2') + val('nec.box4') + val('g.box4') + val('int.box4') + val('div.box4') + val('r.box4') + val('ssa.box6');
      const stateWH = val('state.wh') + val('g.box11');
      const withholdings = fedWH + stateWH;

      // Earned income (for credits)
      const earnedIncome = inc.w2 + inc.schcNet;

      // EV / Energy
      const ev = calcEV() || 0;
      const { applied: energyApplied = 0 } = calcEnergy() || {applied:0};

      // Education
      const { aotc=0, llc=0 } = previewEdu();

      // CTC
      const ctc = computeCTC(earnedIncome);

      // EIC
      const eic = computeEIC(earnedIncome, inc.totalIncome);

      // Split credits
      // Nonrefundable credits apply to INCOME TAX only (demo). We'll apply in this order: AOTC nonref (up to 1500), LLC, EV, Energy, CTC nonref.
      const aotcNonref = Math.max(0, Math.min(1500, aotc)); // AOTC up to 1500 nonref
      const aotcRefundable = Math.max(0, Math.min(1000, aotc - aotcNonref));
      let nonrefPool = fedTax;
      let nonrefUsed = 0;
      function applyNonref(x){ const use = Math.min(nonrefPool, x); nonrefPool -= use; nonrefUsed += use; return use; }
      applyNonref(aotcNonref);
      applyNonref(llc);
      applyNonref(ev);
      applyNonref(energyApplied);
      applyNonref(ctc.nonref);

      const refundableCredits = aotcRefundable + ctc.refundable + eic;

      // Total liability = (income tax after nonref) + SE tax + state tax
      const incomeTaxAfterNonref = Math.max(0, fedTax - nonrefUsed);
      const totalLiability = incomeTaxAfterNonref + seTax + stateTax;

      const refundOrDue = withholdings + refundableCredits - totalLiability;

      // Outputs
      byId('outW2').textContent = money(inc.w2);
      byId('outNEC').textContent = money(inc.schcNet);
      byId('outG').textContent = money(inc.gUnemp + inc.gRefund);
      byId('outINT').textContent = money(inc.intTaxable);
      byId('outDIV').textContent = money(inc.divOrd);
      byId('outR').textContent = money(inc.rTaxable);
      byId('outE').textContent = money(inc.eNet);
      byId('outTotInc').textContent = money(inc.totalIncome);
      byId('outItemized').textContent = money(ded.itemized);
      byId('outStd').textContent = money(ded.standard);
      byId('outTaxable').textContent = money(ded.taxable);
      byId('outFedTax').textContent = money(fedTax);
      byId('outSETax').textContent = money(seTax);
      byId('outStateTax').textContent = money(stateTax);
      byId('outWH').textContent = money(withholdings);
      byId('outNonRefCred').textContent = money(nonrefUsed);
      byId('outRefCred').textContent = money(refundableCredits);
      const dueTxt = (refundOrDue>=0? 'Refund ‚Üë ' : 'Amount Due ‚Üì ');
      byId('outRefund').textContent = dueTxt + money(Math.abs(refundOrDue));
    }

    function parseAdj(text){
      return (text||'').split(/\n+/).map(s=>s.trim()).filter(Boolean).reduce((sum,line)=>{
        const m=line.match(/^([+\-])\s*(\d+(?:\.\d{1,2})?)/); if(!m) return sum; const sign=m[1]==='-'?-1:1; return sum + sign*parseFloat(m[2]);
      },0);
    }
    function renderStateJson(){ byId('stateJson').textContent = JSON.stringify(states, null, 2); }

    // ---------- Receipt ----------
    function generateReceipt(){
      const now = new Date(); const id = 'RCPT-' + now.toISOString().slice(0,10) + '-' + Math.random().toString(36).slice(2,7).toUpperCase();
      const body = `
        <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap">
          <div><strong>Course Demo Tax Prep</strong><div class="note">Training receipt</div></div>
          <div style="text-align:right"><div><strong>#</strong> ${id}</div><div>${now.toLocaleString()}</div></div>
        </div>
        <hr style="border-color:#1f2937"/>
        <div>Tier: <strong>${data['pay.tier']||'Basic'}</strong> ‚Ä¢ Method: <strong>${data['pay.method']||'Card'}</strong></div>
        <div class="note" style="margin-top:6px">Notes: ${data['pay.notes']||'(none)'}</div>`;
      byId('receiptBody').innerHTML = body; byId('receiptPanel').style.display = 'block';
    }

    // ---------- Buttons ----------
    document.getElementById('saveBtn').addEventListener('click',()=>{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); alert('Saved locally.'); });
    document.getElementById('clearBtn').addEventListener('click',()=>{ if(confirm('Clear all saved inputs?')){ localStorage.removeItem(STORAGE_KEY); location.reload(); } });
    document.getElementById('printBtn').addEventListener('click',()=>window.print());
    document.getElementById('genReceipt').addEventListener('click', generateReceipt);
    document.getElementById('markPaid').addEventListener('click',()=>{ byId('paidBadge').style.display = 'inline-block'; });
    document.getElementById('toResults').addEventListener('click',()=> showPage(pages.findIndex(p=>p.id==='page-results')));

    // Live pills
    document.addEventListener('input', recalcLiveCreditPills);
    document.addEventListener('change', recalcLiveCreditPills);
    setTimeout(recalcLiveCreditPills, 0);

    // ---------- Init ----------
    (function init(){
      registerInputs();
      ensureDeps();
      renderDeps();
      const addBtn = document.getElementById('addDepBtn'); if(addBtn) addBtn.addEventListener('click', addDep);
      showPage(0);
      renderStateJson();
    })();
  </script>
</body>
</html>
